<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>FerreyDoc</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
          rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<!-- ========================================================= -->
<!--  CHAT APP - CONTENEDOR FIJO A LA PANTALLA COMPLETA        -->
<!-- ========================================================= -->
<div class="chat-app">

    <!-- =================== HEADER FIJO ======================= -->
    <header class="chat-header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='img/FerreyDoc.png') }}" class="header-avatar">
            <div>
                <div class="header-title">FerreyDoc</div>
                <div class="header-subtitle">En l√≠nea ‚Ä¢ Asistente CAT</div>
            </div>
        </div>
        <div class="header-icons">
            <span class="icon">üîç</span>
            <span class="icon">üë§</span>
        </div>
    </header>

    <!-- =================== √ÅREA SCROLL ======================= -->
    <main id="chat-box" class="chat-scroll"></main>

    <!-- =================== INDICADOR TYPING ================== -->
    <div id="typing-indicator" class="typing hidden">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>

    <!-- =================== INPUT FIJO ======================== -->
    <footer class="input-bar">
        <span class="emoji">üòä</span>
        <input id="mensaje" type="text" placeholder="Mensaje‚Ä¶" autocomplete="off">
        <span class="mic">üé§</span>
        <button onclick="enviarMensaje()" class="send-btn">‚û§</button>
    </footer>

</div>

<script>
/* --------------- JS ORIGINAL (NO CAMBIADO) ---------------- */
const chatBox = document.getElementById("chat-box");
const typingIndicator = document.getElementById("typing-indicator");
const inputMensaje = document.getElementById("mensaje");

function horaActual() {
    return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

function estadoMensajeHTML(e) {
    if (e==="enviado") return `<span class="msg-check">‚úì</span>`;
    if (e==="entregado") return `<span class="msg-check">‚úì‚úì</span>`;
    if (e==="leido") return `<span class="msg-check msg-check-blue">‚úì‚úì</span>`;
}

function addBotMessage(text) {
    const hora = horaActual();
    chatBox.innerHTML += `
        <div class="bot-msg">
            <img src="{{ url_for('static', filename='img/FerreyDoc.png') }}" class="msg-avatar">
            <div class="msg-block">
                <div class="bot-bubble">${text}</div>
                <div class="msg-time-left">${hora}</div>
            </div>
        </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------- NUEVO: descargar PDF desde base64 ---------- */
function descargarPdfDesdeBase64(pdfBase64, filename) {
    const byteCharacters = atob(pdfBase64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "FerreyDoc_Reporte.pdf";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function addUserMessage(text) {
    const hora = horaActual();
    chatBox.innerHTML += `
        <div class="user-msg">
            <div class="msg-block-right">
                <div class="user-bubble">${text}</div>
                <div class="msg-time-right">${hora} ${estadoMensajeHTML("enviado")}</div>
            </div>
        </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function enviarMensaje() {
    const msg = inputMensaje.value.trim();
    if (!msg) return;

    addUserMessage(msg);
    inputMensaje.value = "";
    typingIndicator.classList.remove("hidden");

    const resp = await fetch("/enviar", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({mensaje: msg})
    });
    const data = await resp.json();

    typingIndicator.classList.add("hidden");

    // Construimos la respuesta del bot manteniendo el HTML original del backend
    let respuestaTexto = data.respuesta || "";

    // Si el backend manda una imagen explicativa, la agregamos debajo del texto
    if (data.imagen) {
        const imagenHtml = `<br><img src="${data.imagen}" class="bot-extra-img">`;
        respuestaTexto += imagenHtml;
    }

    if (respuestaTexto) {
        addBotMessage(respuestaTexto);
    }

    // Si llega un PDF en base64, disparamos la descarga
    if (data.pdf_base64) {
        descargarPdfDesdeBase64(data.pdf_base64, data.filename);
    }
}

inputMensaje.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        enviarMensaje();
    }
});
</script>

</body>
</html>
